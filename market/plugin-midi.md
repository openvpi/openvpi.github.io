# MIDI 转换插件

适用格式：MIDI 文件 (*.mid)

版本：0.5.0

最后更新日期：2022.05.27

作者：[笛鹿FlutyDeer](https://space.bilibili.com/386270936)

## 简介

本插件支持标准 MIDI 文件，即 [Standard MIDI Files (SMF)](https://www.midi.org/specifications/category/smf-specifications) ，与其他格式互相转换。由于输入或输出平台的不同，部分数据可能无法与源平台或目标平台一一对应。

## 数据支持清单

### 读取 MIDI 文件

| 数据内容 | 支持等级 |                             说明                             |
| :------: | :------: | :----------------------------------------------------------: |
|   轨道   |    ○     | 暂不支持轨道名称导入。暂不支持多通道 MIDI 轨道分轨导入，即使一个轨道内有多个通道，也只导入首个通道内的事件。 |
|   曲谱   |    ○     |              暂不支持拍号导入。拍号默认为4/4。               |
|   歌词   |    ✓     |     实验性选项。如果歌词包含字母时将作为“修改发音”转换。     |
| 音高参数 |    ×     | 暂不支持将弯音轮事件（Pitch Bend Event）映射为音高参数导入。 |
| 音量参数 |    ×     | 暂不支持将 MIDI 7号控制器（音量）事件（MIDI CC #7 Volume Event）映射为音量参数导入。 |
| 力度参数 |    ×     | 暂不支持将 MIDI 11号控制器（表情）事件（MIDI CC #7 Expression Event）映射为力度参数导入。 |

### 写入MIDI 文件

| 数据内容 | 支持等级 |                             说明                             |
| :------: | :------: | :----------------------------------------------------------: |
|   轨道   |    ○     |                    暂不支持导出轨道名称。                    |
|   曲谱   |    ✓     |                                                              |
|   歌词   |    ✓     | 如果修改过源格式音符的发音，将会把修改后的发音作为歌词导出。 |
| 音高参数 |    ×     |             暂不支持将音高参数映射为弯音轮事件。             |
| 音量参数 |    ×     |       暂不支持将音量参数映射为7号控制器（音量）事件。        |
| 力度参数 |    ×     |       暂不支持将音量参数映射为11号控制器（表情）事件。       |

## 高级选项

### 输入选项

#### 导入歌词（实验性）

启用此选项，将会尝试导入 MIDI 文件中的歌词。

> **[!WARNING]**
>
> 此功能尚不成熟，启用本选项可能出现无法预料的情况。如果启用此选项后遇到转换错误，请关闭它，并向开发者反馈。


> **[!NOTE]**
>
> 启用本选项后，本插件会遍历所有的 MIDI 事件（MIDI Event），根据歌词事件（Lyric Event）、音符按下事件（Note On Event）和音符松开事件（Note Off Event）生成音符。

#### 歌词文本编码

指定导入歌词时所用的文本编码。除非歌词出现乱码，否则不应更改此设置。

此选项支持的值如下：
- ASCII
- BigEndianUnicode
- Default
- Unicode
- UTF-32
- UTF-7
- UTF-8 BOM
- UTF-8

#### 有错误的 MIDI 文件导入策略

指定如何处理含有错误的 MIDI 文件。选择“忽略错误”，软件将会尝试导入含有错误的 MIDI 文件，但不保证能正确导入。

此选项支持的值如下：
- 中止
- 忽略错误

### 输出选项

#### 移调

单位为半音。若要降低一个八度，则输入“-12”。对于移调后超出 MIDI 音高范围的音符，将会被限制在边缘。

#### 移除歌词中的常见标点符号

移除中英文的逗号、句号、问号和感叹号，防止不支持含标点符号歌词的歌声合成软件无法正常合成。

#### 歌词兼容性模式

将所有中文歌词转换为拼音，防止不支持导入带有中文歌词 MIDI 文件的歌声合成软件出现乱码。

#### 歌词文本编码

除非打开歌词兼容性模式后仍然乱码，否则不应更改此设置。

此选项支持的值如下：
- ASCII
- BigEndianUnicode
- Default
- Unicode
- UTF-32
- UTF-7
- UTF-8 BOM
- UTF-8

#### 时基(PPQ)

即 parts per quarter, 又名 ticks per quarter note，每四分音符的脉冲数。除非你知道这是什么，否则不应更改此设置。

> **[!NOTE]**
>
> 在 MIDI 中，时间是用梯（ticks）而不是秒或者其他单位表示的。MIDI 系统是由 MIDI 时钟驱动的，时钟能产生脉冲。一个脉冲到来，梯的值就增加一。时钟产生脉冲的频率是根据曲速来定的，这里不展开来讲。时基（time division）是指每四分音符的脉冲数（ticks per quarter note），描述的是 MIDI 系统的时间分辨率。如果时基设置为480，那么演奏一个四分音符的时间就是480梯。换句话说，当 MIDI 系统数够了480个脉冲，则表示经过了一个四分音符的时间。数值越大，MIDI 系统的时间分辨率就越高，也就是说可以演奏时值越小的音符。如果要将 MIDI 文件的播放速度提高两倍，可以将默认的时基（480）除以2，即改成240。

#### 半元音前移量

非负整数，单位为梯。输入负数视为零。将发音为 y-、w- 和 er 的音符提前，以缓解某些歌声合成软件半元音音符出现迟滞的问题。推荐值：30~60。

## 更新日志

#### v0.5.0 (2022.05.27)

- 新增读取 MIDI 文件遇到错误处理选项，即使是损坏或包含错误的 MIDI 文件，也能尝试转换
- 新增是否导入歌词选项。由于导入歌词尚处于实验阶段，如果出现问题，可以关闭此选项并向开发者反馈
- 修复 PPQ 不为480时音符位置和时长错误的问题
- 修复导入不带词 MIDI 文件时音符错位的问题

#### v0.4.1 (2022.05.25)

- 支持带词 MIDI 文件反向转换成其他格式（可能还有不少bug，欢迎大家反馈）。
- 修复了半元音前移的一个小bug。

#### v0.3.2 (2022.05.18)

- 修改文案和半元音前移量的推荐值。

#### v0.2.2 (2022.05.06)

随转换器公测发布